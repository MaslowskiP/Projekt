<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-type" content="text/html; charset=utf-8">
		<script src="js/pgb.js"></script>
		<script src="cordova.js"></script>
		<link rel="stylesheet" href="css/jquery.mobile-1.4.5.min.css" />
		<script src="js/jquery-2.1.4.min.js"></script>
		<script src="js/jquery.mobile-1.4.5.min.js"></script>
		<script src = "https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>

		
	</head>
	<body onload="init()">
		
		
		<div data-role="page" id="pageone">
		


		
		  <div data-role="header">
			<h1>Lista produktów</h1>
			<button class="ui-btn ui-icon-arrow-d ui-btn-icon-left" id="zaczytaj">Zaczytaj listę</button>
		  </div>
		  
	  
		  <div data-role="main" class="ui-content">
			<p>

			
			<div id="lista"></div>
			<script type = "text/javascript" language = "javascript">

			var db = openDatabase('comiclist', '1.0', 'Baza z produktami', 2 * 1024 * 1024);
			
			db.transaction(function (tx) {
				
				tx.executeSql('CREATE TABLE IF NOT EXISTS COMICS (id unique, name, code, status)');
				//tx.executeSql('INSERT INTO COMICS (id, name, code, status) VALUES (0, "ALL STAR BATMAN #10", "MAR170261", 0)'); //do testów
			});


		 db.transaction(function (tx) {
		 
            tx.executeSql('SELECT * FROM COMICS WHERE status=0', [], function (tx, results) {
			
				var dlugosc = results.rows.length, y;
				
				//$('#lista').append('Znaleziono taka ilość wpisów: ' + dlugosc + '<br>'); // do testów
					
               for (y = 0; y < dlugosc; y++){
					//$('#lista').append(results.rows.item(y).name + ' ' + results.rows.item(y).code + ' ' + results.rows.item(y).id +'<br>'); //tylko do testrów
					dodaj(results.rows.item(y).name, results.rows.item(y).code, results.rows.item(y).id)
               }
            }, null);
			
			//tx.executeSql('DROP TABLE IF EXISTS COMICS'); // do testów 
         });
			
			
			
			$(document).ready(function() {
				$("#zaczytaj").click(function(event){

				pobierzListe();
				});
			});
			
			
			
			
			
			function usun(id) {
			
				$("#komiks_" + id).html("");
				db.transaction(function (tx) {
			
					tx.executeSql('UPDATE COMICS SET status=1 WHERE id=?', [id]);
				
				});
				
				
				
			}
			
			
			function pobierzListe() {
			
			//najpierw obsługa bazy danych - usuwa tabelę a następnie ją tworzy (poprostu czyści tabelę ze starej listy produktów)
			db.transaction(function (tx) {
			
				tx.executeSql('DROP TABLE IF EXISTS COMICS');
				tx.executeSql('CREATE TABLE IF NOT EXISTS COMICS (id unique, name, code, status)');
				
			});
			//reszta funkcji pobierająca liste komiksów
			
			var lista = 'https://query.yahooapis.com/v1/public/yql?q=select%20*%20from%20html%20where%20url%3D%22http%3A%2F%2Fwizard.uek.krakow.pl%2F~s181008%2Flista2.txt%22%20&format=json&diagnostics=true&callback=';
			var zawartosc;
			var kod;
			
			$.getJSON(lista , function(jd2) {
			
				zawartosc = jd2.query.results.body;
				zawartosc = zawartosc.split('\n');

				db.transaction(function (tx) {	// funkcja z bazą danych musi się zaczynać tutaj bo inaczej nie działa patrz tutaj: http://stackoverflow.com/questions/12586367/only-the-last-run-in-a-for-loop-in-javascript-works
				for (i = 0; i < zawartosc.length; i++) {
					kod = zawartosc[i].split(';');
					dodaj (kod[0], kod[1], i);
					
						tx.executeSql('INSERT INTO COMICS (id, name, code, status) VALUES (?, ?, ?, 0)', [i, kod[0], kod[1]] ); //dodaje nowy wpis do bazy danych

					}
				});
			});
			
			}
			

			
			function dodaj (nazwa, kod, num) {
			

			var id = "#"+kod;
			
			var link = "https://query.yahooapis.com/v1/public/yql?q=select+src+from+html+where+url%3D%22https%3A%2F%2Fpreviewsworld.com%2FCatalog%2F"+kod+"%22+and%0A++++++xpath%3D%27%2F%2Fdiv%2Fa%2Fimg%27+LIMIT+1&format=json";
			   
			$.getJSON(link, function(jd) {
                  $('#obrazek_' + num).html('<a href="#" data-rel="back" class="ui-btn ui-corner-all ui-shadow ui-btn ui-icon-delete ui-btn-icon-notext ui-btn-right">Zamknij</a><img src="https://www.previewsworld.com'+jd.query.results.img.src+'" style="width:400px;height:600px;" alt="'+kod+'">');
               }); //dodawanie obrazka
			
			
			$('#komiks_' + num).html(nazwa + '<a href="#obrazek_'+num+'" data-rel="popup" data-position-to="window" class="ui-btn ui-icon-camera ui-btn-icon-left ui-btn-inline" >Zdjęcie</a> <a href="#wiadomosc" data-rel="popup" data-position-to="window" class="ui-btn ui-icon-comment ui-btn-icon-left ui-btn-inline">Wiadomość</a> <button class="ui-btn ui-icon-arrow-d ui-btn-icon-left ui-icon-check ui-btn-inline" onclick="usun('+num+')">Produkt znaleziono</button><hr>'); //dodawanie komiksu
			

			}
			
			
			
			
			
			
			</script>
			<div id="komiks_0"></div>
			<div id="komiks_1"></div>
			<div id="komiks_2"></div>
			<div id="komiks_3"></div>
			<div id="komiks_4"></div>
			
			
			<div data-role="popup" id="obrazek_0"></div>
			<div data-role="popup" id="obrazek_1"></div>
			<div data-role="popup" id="obrazek_2"></div>
			<div data-role="popup" id="obrazek_3"></div>
			<div data-role="popup" id="obrazek_4"></div>

			<div data-role="popup" id="wiadomosc">
			    <a href="#" data-rel="back" class="ui-btn ui-corner-all ui-shadow ui-btn ui-icon-delete ui-btn-icon-notext ui-btn-right">Zamknij</a>
						<form method="post" action="jakasfunkcja">
							<fieldset class="ui-field-contain">
								<label for="message">Wybierz komentarz</label>
									<select name="message" id="message">
										<option value="1">Ostatnia sztuka produktu</option>
										<option value="2">Brak produktu</option>
										<option value="3">Produkt uszkodzony</option>
									</select>
							</fieldset>
						<input type="submit" data-inline="true" value="Dodaj komentarz">
						</form>
			</div>
			
			</p>
		  </div>
		  <div data-role="footer" data-position="fixed">
			<!-- <h1>(c) Piotr Masłowski, Adrian Myszor</h1> -->
			<button class="ui-btn ui-icon-mail ui-btn-icon-left">Wyślij raport</button>
		  </div> 
		</div> 
		
	
		
	</body>
</html>
